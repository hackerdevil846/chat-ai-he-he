module.exports.config = {
    name: "vtuber",
    version: "1.0.0",
    hasPermssion: 0,
    credits: "ğ‘¨ğ’”ğ’Šğ’‡ ğ‘´ğ’‚ğ’‰ğ’ğ’–ğ’…",
    description: "ğ‘¹ğ’‚ğ’ğ’…ğ’ğ’ ğ‘½ğ‘»ğ’–ğ’ƒğ’†ğ’“ ğ’†ğ’“ ğ’„ğ’‰ğ’‰ğ’ğ’ƒğ’Š ğ’•ğ’ğ’Šğ’“ğ’Š ğ’Œğ’ğ’“ğ’–ğ’",
    commandCategory: "vtuber",
    usages: "[gura/marine/rushia/pekora/coco/korone/amelia/fubuki/okayu/watame/uto/chloe/ayame/polka/botan/aloe]",
    cooldowns: 5
};

module.exports.run = async function({ api, event, args }) {
  const axios = require('axios');
  const request = require('request');
  const fs = require("fs");
  const { threadID, messageID } = event;
  var type;
  switch(args[0]) {
    case "rushia":
    case "Rushia":
    type = "rushia";
    break;
    case "pekora":
    case "Pekora":
    case "peko":
    case "Peko":
    type = "pekora";
    break;
    case "coco": 
    case "Coco":
    type = "coco";
    break;
    case "gura":
    case "Gura":
    case "gawr":
    case "Gawr":
    type = "gura";
    break;
    case "marine":
    case "Marine":
    case "Marin":
    type = "marine";
    break;
    case "korone":
    case "Korone":
    type = "korone";
    break;
    case "amelia":
    case "Amelia":
    case "ame":
    case "Ame":
    type = "amelia";
    break;
    case "fubuki":
    case "Fubuki":
    type = "fubuki";
    break;
    case "okayu":
    case "Okayu":
    type = "okayu";
    break;
    case "watame":
    case "Watame":
    type = "watame";
    break;
    case "uto":
    case "Uto":
    type = "uto";
    break;
    case "chloe":
    case "Chloe":
    type = "chloe";
    break;
    case "ayame":
    case "Ayame":
    type = "ayame";
    break;
    case "polka":
    case "Polka":
    type = "polka";
    break;
    case "botan":
    case "Botan":
    type = "botan";
    break;
    case "aloe":
    case "Aloe":
    type = "aloe";
    break;
    default:
    return api.sendMessage(`ğ‘ªğ’‰ğ’‚ğ’“ğ’‚ğ’„ğ’•ğ’†ğ’“ ğ’†ğ’“ ğ’ğ’Šğ’”ğ’•:\n [gura/marine/rushia/pekora/coco/korone/amelia/fubuki/okayu/watame/uto/chloe/ayame/polka/botan/aloe]\n\nğ‘¼ğ’…ğ’‚ğ’‰ğ’ğ’“ğ’ğ’:\n${global.config.PREFIX}vtuber gura`, threadID, messageID);
    break;
  }
  
  // ğ‘©ğ’‚ğ’„ğ’Œğ’–ğ’‘ ğ‘¨ğ‘·ğ‘° ğ’ğ’Šğ’”ğ’•
  const apis = [
    `https://api.randvtuber-saikidesu.ml?character=${type}`,
    `https://api.waifu.pics/sfw/waifu`, // ğ‘©ğ’‚ğ’„ğ’Œğ’–ğ’‘ ğ‘¨ğ‘·ğ‘° 1
    `https://nekos.life/api/v2/img/neko`, // ğ‘©ğ’‚ğ’„ğ’Œğ’–ğ’‘ ğ‘¨ğ‘·ğ‘° 2
    `https://api.nekosapi.com/v2/images/neko` // ğ‘©ğ’‚ğ’„ğ’Œğ’–ğ’‘ ğ‘¨ğ‘·ğ‘° 3
  ];

  let success = false;
  for (let i = 0; i < apis.length; i++) {
    try {
      const res = await axios.get(apis[i]);
      let imageUrl;
      let name = type;
      let count = "ğ‘µ/ğ‘¨";
      let author = "ğ‘½ğ’‚ğ’“ğ’Šğ’ğ’–ğ’”";
      
      // ğ‘·ğ’“ğ’Šğ’ğ’‚ğ’“ğ’š ğ‘¨ğ‘·ğ‘° ğ’“ğ’†ğ’”ğ’‘ğ’ğ’ğ’”ğ’† ğ’‰ğ’‚ğ’ğ’…ğ’ğ’Šğ’ğ’ˆ
      if (i === 0 && res.data.url) {
        imageUrl = res.data.url;
        name = res.data.name || type;
        count = res.data.count || "ğ‘µ/ğ‘¨";
        author = res.data.author || "ğ‘½ğ’‚ğ’“ğ’Šğ’ğ’–ğ’”";
      }
      // ğ‘©ğ’‚ğ’„ğ’Œğ’–ğ’‘ ğ‘¨ğ‘·ğ‘° ğ’“ğ’†ğ’”ğ’‘ğ’ğ’ğ’”ğ’† ğ’‰ğ’‚ğ’ğ’…ğ’ğ’Šğ’ğ’ˆ
      else if (res.data.url) {
        imageUrl = res.data.url;
      }
      
      if (imageUrl) {
        let ext = imageUrl.substring(imageUrl.lastIndexOf(".") + 1);
        if (!ext || ext.length > 4) ext = "jpg";
        
        let callback = function () {
          api.sendMessage({
            body: `=== ${name} ===\nğ‘¼ğ’‘ğ’‚ğ’ğ’ğ’ƒğ’…ğ’‰ğ’: ${count}\nğ‘³ğ’†ğ’Œğ’‰ğ’ğ’Œ: ${author}\n\nğ‘ªğ’“ğ’†ğ’…ğ’Šğ’•ğ’”: ğ‘¨ğ’”ğ’Šğ’‡ ğ‘´ğ’‚ğ’‰ğ’ğ’–ğ’…`,
            attachment: fs.createReadStream(__dirname + `/cache/${type}.${ext}`)
          }, event.threadID, () => fs.unlinkSync(__dirname + `/cache/${type}.${ext}`), event.messageID);
          api.setMessageReaction("âœ…", event.messageID, (err) => {}, true);
        };
        
        request(imageUrl).pipe(fs.createWriteStream(__dirname + `/cache/${type}.${ext}`)).on("close", callback);
        success = true;
        break;
      }
    } catch (err) {
      console.error(`ğ‘¨ğ‘·ğ‘° ${apis[i]} ğ’† ğ’”ğ’ğ’ğ’ğ’”ğ’”ğ’‚:`, err);
    }
  }

  if (!success) {
    api.sendMessage("ğ‘ªğ’‰ğ’‰ğ’ğ’ƒğ’Š ğ’•ğ’ğ’Šğ’“ğ’Š ğ’Œğ’ğ’“ğ’•ğ’† ğ’”ğ’ğ’ğ’ğ’”ğ’”ğ’‚ ğ’‰ğ’ğ’šğ’†ğ’„ğ’‰ğ’†, ğ’‚ğ’ƒğ’‚ğ’“ ğ’„ğ’‰ğ’†ğ’”ğ’‰ğ’•ğ’‚ ğ’Œğ’ğ’“ğ’–ğ’!", event.threadID, event.messageID);
    api.setMessageReaction("â˜¹ï¸", event.messageID, (err) => {}, true);
  }
}

